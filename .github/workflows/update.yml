name: Auto-update packages

on:
  schedule:
    - cron: '0 * * * *'  # Run hourly
  workflow_dispatch:  # Allow manual trigger

jobs:
  update:
    runs-on: ubuntu-latest
    outputs:
      any-updated: ${{ steps.check.outputs.any-updated }}
      pi-updated: ${{ steps.update-pi.outputs.updated }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Install Nushell
        run: |
          nix profile install nixpkgs#nushell

      - name: Update codex-cli
        id: update-codex
        run: |
          OUTPUT=$(nu scripts/update-package.nu codex-cli)
          echo "$OUTPUT"

          UPDATED=$(echo "$OUTPUT" | grep "updated=" | cut -d= -f2)
          CURRENT=$(echo "$OUTPUT" | grep "current=" | cut -d= -f2 || echo "")
          LATEST=$(echo "$OUTPUT" | grep "latest=" | cut -d= -f2 || echo "")

          echo "updated=$UPDATED" >> $GITHUB_OUTPUT
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "latest=$LATEST" >> $GITHUB_OUTPUT

      - name: Update claude-code
        id: update-claude
        run: |
          OUTPUT=$(nu scripts/update-package.nu claude-code)
          echo "$OUTPUT"

          UPDATED=$(echo "$OUTPUT" | grep "updated=" | cut -d= -f2)
          CURRENT=$(echo "$OUTPUT" | grep "current=" | cut -d= -f2 || echo "")
          LATEST=$(echo "$OUTPUT" | grep "latest=" | cut -d= -f2 || echo "")

          echo "updated=$UPDATED" >> $GITHUB_OUTPUT
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "latest=$LATEST" >> $GITHUB_OUTPUT

      - name: Update gemini-cli
        id: update-gemini
        run: |
          OUTPUT=$(nu scripts/update-package.nu gemini-cli)
          echo "$OUTPUT"

          UPDATED=$(echo "$OUTPUT" | grep "updated=" | cut -d= -f2)
          CURRENT=$(echo "$OUTPUT" | grep "current=" | cut -d= -f2 || echo "")
          LATEST=$(echo "$OUTPUT" | grep "latest=" | cut -d= -f2 || echo "")

          echo "updated=$UPDATED" >> $GITHUB_OUTPUT
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "latest=$LATEST" >> $GITHUB_OUTPUT

      - name: Update crush
        id: update-crush
        run: |
          OUTPUT=$(nu scripts/update-package.nu crush)
          echo "$OUTPUT"

          UPDATED=$(echo "$OUTPUT" | grep "updated=" | cut -d= -f2)
          CURRENT=$(echo "$OUTPUT" | grep "current=" | cut -d= -f2 || echo "")
          LATEST=$(echo "$OUTPUT" | grep "latest=" | cut -d= -f2 || echo "")

          echo "updated=$UPDATED" >> $GITHUB_OUTPUT
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "latest=$LATEST" >> $GITHUB_OUTPUT

      - name: Update opencode
        id: update-opencode
        run: |
          OUTPUT=$(nu scripts/update-package.nu opencode)
          echo "$OUTPUT"

          UPDATED=$(echo "$OUTPUT" | grep "updated=" | cut -d= -f2)
          CURRENT=$(echo "$OUTPUT" | grep "current=" | cut -d= -f2 || echo "")
          LATEST=$(echo "$OUTPUT" | grep "latest=" | cut -d= -f2 || echo "")

          echo "updated=$UPDATED" >> $GITHUB_OUTPUT
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "latest=$LATEST" >> $GITHUB_OUTPUT

      - name: Update pi
        id: update-pi
        run: |
          OUTPUT=$(nu scripts/update-package.nu pi)
          echo "$OUTPUT"

          UPDATED=$(echo "$OUTPUT" | grep "updated=" | cut -d= -f2)
          CURRENT=$(echo "$OUTPUT" | grep "current=" | cut -d= -f2 || echo "")
          LATEST=$(echo "$OUTPUT" | grep "latest=" | cut -d= -f2 || echo "")

          echo "updated=$UPDATED" >> $GITHUB_OUTPUT
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "latest=$LATEST" >> $GITHUB_OUTPUT

      - name: Update gondolin
        id: update-gondolin
        run: |
          OUTPUT=$(nu scripts/update-package.nu gondolin)
          echo "$OUTPUT"

          UPDATED=$(echo "$OUTPUT" | grep "updated=" | cut -d= -f2)
          CURRENT=$(echo "$OUTPUT" | grep "current=" | cut -d= -f2 || echo "")
          LATEST=$(echo "$OUTPUT" | grep "latest=" | cut -d= -f2 || echo "")

          echo "updated=$UPDATED" >> $GITHUB_OUTPUT
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "latest=$LATEST" >> $GITHUB_OUTPUT

      - name: Test builds
        if: steps.update-codex.outputs.updated == 'true' || steps.update-claude.outputs.updated == 'true' || steps.update-gemini.outputs.updated == 'true' || steps.update-crush.outputs.updated == 'true' || steps.update-opencode.outputs.updated == 'true' || steps.update-pi.outputs.updated == 'true' || steps.update-gondolin.outputs.updated == 'true'
        run: |
          echo "Testing package builds..."
          nix flake check --print-build-logs

      - name: Check if any updated
        id: check
        run: |
          if [ "${{ steps.update-codex.outputs.updated }}" == "true" ] || \
             [ "${{ steps.update-claude.outputs.updated }}" == "true" ] || \
             [ "${{ steps.update-gemini.outputs.updated }}" == "true" ] || \
             [ "${{ steps.update-crush.outputs.updated }}" == "true" ] || \
             [ "${{ steps.update-opencode.outputs.updated }}" == "true" ] || \
             [ "${{ steps.update-pi.outputs.updated }}" == "true" ] || \
             [ "${{ steps.update-gondolin.outputs.updated }}" == "true" ]; then
            echo "any-updated=true" >> $GITHUB_OUTPUT
          else
            echo "any-updated=false" >> $GITHUB_OUTPUT
          fi

      - name: Prepare commit message
        if: steps.check.outputs.any-updated == 'true'
        run: |
          MSG="chore: update packages"

          if [ "${{ steps.update-codex.outputs.updated }}" == "true" ]; then
            MSG="$MSG\n\n- codex-cli: ${{ steps.update-codex.outputs.current }} → ${{ steps.update-codex.outputs.latest }}"
          fi

          if [ "${{ steps.update-claude.outputs.updated }}" == "true" ]; then
            MSG="$MSG\n- claude-code: ${{ steps.update-claude.outputs.current }} → ${{ steps.update-claude.outputs.latest }}"
          fi

          if [ "${{ steps.update-gemini.outputs.updated }}" == "true" ]; then
            MSG="$MSG\n- gemini-cli: ${{ steps.update-gemini.outputs.current }} → ${{ steps.update-gemini.outputs.latest }}"
          fi

          if [ "${{ steps.update-crush.outputs.updated }}" == "true" ]; then
            MSG="$MSG\n- crush: ${{ steps.update-crush.outputs.current }} → ${{ steps.update-crush.outputs.latest }}"
          fi

          if [ "${{ steps.update-opencode.outputs.updated }}" == "true" ]; then
            MSG="$MSG\n- opencode: ${{ steps.update-opencode.outputs.current }} → ${{ steps.update-opencode.outputs.latest }}"
          fi

          if [ "${{ steps.update-pi.outputs.updated }}" == "true" ]; then
            MSG="$MSG\n- pi: ${{ steps.update-pi.outputs.current }} → ${{ steps.update-pi.outputs.latest }}"
          fi

          if [ "${{ steps.update-gondolin.outputs.updated }}" == "true" ]; then
            MSG="$MSG\n- gondolin: ${{ steps.update-gondolin.outputs.current }} → ${{ steps.update-gondolin.outputs.latest }}"
          fi

          echo -e "$MSG" > commit-message.txt

      - name: Upload updated files
        if: steps.check.outputs.any-updated == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: updated-packages
          path: |
            packages/
            README.md
            commit-message.txt

  pi-macos-hash:
    needs: update
    if: needs.update.outputs.pi-updated == 'true'
    runs-on: macos-latest
    outputs:
      hash: ${{ steps.compute.outputs.hash }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download updated files
        uses: actions/download-artifact@v4
        with:
          name: updated-packages

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Compute macOS hash for pi
        id: compute
        run: |
          FAKE="sha256-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA="
          sed -i '' 's|"aarch64-darwin" = "sha256-[^"]*"|"aarch64-darwin" = "'"$FAKE"'"|' packages/pi/default.nix
          RESULT=$(nix build .#pi --no-link 2>&1 || true)
          HASH=$(echo "$RESULT" | grep 'got:' | head -1 | awk '{print $2}')
          if [ -z "$HASH" ]; then
            echo "Error: Could not extract hash from build output:"
            echo "$RESULT"
            exit 1
          fi
          echo "Computed aarch64-darwin hash: $HASH"
          echo "hash=$HASH" >> $GITHUB_OUTPUT

  commit:
    needs: [update, pi-macos-hash]
    if: always() && needs.update.result == 'success' && needs.update.outputs.any-updated == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download updated files
        uses: actions/download-artifact@v4
        with:
          name: updated-packages

      - name: Patch macOS hash for pi
        if: needs.pi-macos-hash.result == 'success'
        run: |
          HASH="${{ needs.pi-macos-hash.outputs.hash }}"
          if [ -z "$HASH" ]; then
            echo "Error: macOS hash output is empty"
            exit 1
          fi
          sed -i 's|"aarch64-darwin" = "sha256-[^"]*"|"aarch64-darwin" = "'"$HASH"'"|' packages/pi/default.nix

      - name: Verify pi hashes are not fake
        if: needs.update.outputs.pi-updated == 'true'
        run: |
          FAKE="sha256-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA="
          if grep -q "$FAKE" packages/pi/default.nix; then
            echo "Error: pi default.nix still contains a fake hash"
            grep "$FAKE" packages/pi/default.nix
            exit 1
          fi

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push changes
        run: |
          git add packages/ README.md
          git commit -m "$(cat commit-message.txt)"
          git push
