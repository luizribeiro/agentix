name: Auto-update packages

on:
  schedule:
    - cron: '0 * * * *'  # Run hourly
  workflow_dispatch:  # Allow manual trigger

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update codex-cli
        id: update-codex
        run: |
          # Fetch latest version from npm
          LATEST=$(curl -s https://registry.npmjs.org/@openai/codex | jq -r '.["dist-tags"].latest')
          CURRENT=$(grep 'version = ' packages/codex-cli/default.nix | sed 's/.*"\(.*\)".*/\1/')

          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "latest=$LATEST" >> $GITHUB_OUTPUT

          if [ "$CURRENT" != "$LATEST" ]; then
            echo "Updating codex-cli from $CURRENT to $LATEST"

            # Fetch new hash
            HASH=$(nix-prefetch-url "https://registry.npmjs.org/@openai/codex/-/codex-$LATEST.tgz")
            SRI_HASH=$(nix hash convert --hash-algo sha256 "$HASH")

            # Update version and hash
            sed -i "s/version = \".*\"/version = \"$LATEST\"/" packages/codex-cli/default.nix
            sed -i "s|hash = \"sha256-.*\"|hash = \"$SRI_HASH\"|" packages/codex-cli/default.nix

            echo "updated=true" >> $GITHUB_OUTPUT
          else
            echo "codex-cli is up to date"
            echo "updated=false" >> $GITHUB_OUTPUT
          fi

      - name: Update claude-code
        id: update-claude
        run: |
          # Fetch latest version from npm
          LATEST=$(curl -s https://registry.npmjs.org/@anthropic-ai/claude-code | jq -r '.["dist-tags"].latest')
          CURRENT=$(grep 'version = ' packages/claude-code/default.nix | sed 's/.*"\(.*\)".*/\1/')

          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "latest=$LATEST" >> $GITHUB_OUTPUT

          if [ "$CURRENT" != "$LATEST" ]; then
            echo "Updating claude-code from $CURRENT to $LATEST"

            # Fetch new hash
            HASH=$(nix-prefetch-url "https://registry.npmjs.org/@anthropic-ai/claude-code/-/claude-code-$LATEST.tgz")
            SRI_HASH=$(nix hash convert --hash-algo sha256 "$HASH")

            # Update version and hash
            sed -i "s/version = \".*\"/version = \"$LATEST\"/" packages/claude-code/default.nix
            sed -i "s|hash = \"sha256-.*\"|hash = \"$SRI_HASH\"|" packages/claude-code/default.nix

            echo "updated=true" >> $GITHUB_OUTPUT
          else
            echo "claude-code is up to date"
            echo "updated=false" >> $GITHUB_OUTPUT
          fi

      - name: Update gemini-cli
        id: update-gemini
        run: |
          # Fetch latest stable version from npm (not nightly)
          LATEST=$(curl -s https://registry.npmjs.org/@google/gemini-cli | jq -r '.["dist-tags"].latest')
          CURRENT=$(grep 'version = ' packages/gemini-cli/default.nix | sed 's/.*"\(.*\)".*/\1/')

          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "latest=$LATEST" >> $GITHUB_OUTPUT

          if [ "$CURRENT" != "$LATEST" ]; then
            echo "Updating gemini-cli from $CURRENT to $LATEST"

            # Update version first
            sed -i "s/version = \".*\"/version = \"$LATEST\"/" packages/gemini-cli/default.nix

            # Set fake hashes to trigger rebuild
            sed -i "s|hash = \"sha256-.*\"|hash = \"sha256-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=\"|" packages/gemini-cli/default.nix
            sed -i "s|npmDepsHash = \"sha256-.*\"|npmDepsHash = \"sha256-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=\"|" packages/gemini-cli/default.nix

            # Get source hash
            SRC_HASH=$(nix build .#gemini-cli --no-link 2>&1 | grep "got:" | awk '{print $2}' || echo "")
            if [ -z "$SRC_HASH" ]; then
              echo "Failed to get source hash"
              exit 1
            fi
            sed -i "0,/hash = \"sha256-.*\"/s||hash = \"$SRC_HASH\"|" packages/gemini-cli/default.nix

            # Get npmDepsHash
            NPM_HASH=$(nix build .#gemini-cli --no-link 2>&1 | grep "got:" | awk '{print $2}' || echo "")
            if [ -z "$NPM_HASH" ]; then
              echo "Failed to get npmDepsHash"
              exit 1
            fi
            sed -i "s|npmDepsHash = \"sha256-.*\"|npmDepsHash = \"$NPM_HASH\"|" packages/gemini-cli/default.nix

            echo "updated=true" >> $GITHUB_OUTPUT
          else
            echo "gemini-cli is up to date"
            echo "updated=false" >> $GITHUB_OUTPUT
          fi

      - name: Test builds
        if: steps.update-codex.outputs.updated == 'true' || steps.update-claude.outputs.updated == 'true' || steps.update-gemini.outputs.updated == 'true'
        run: |
          echo "Testing package builds..."
          nix flake check --print-build-logs

      - name: Commit and push changes
        if: steps.update-codex.outputs.updated == 'true' || steps.update-claude.outputs.updated == 'true' || steps.update-gemini.outputs.updated == 'true'
        run: |
          git add packages/

          COMMIT_MSG="chore: update packages"

          if [ "${{ steps.update-codex.outputs.updated }}" == "true" ]; then
            COMMIT_MSG="$COMMIT_MSG\n\n- codex-cli: ${{ steps.update-codex.outputs.current }} → ${{ steps.update-codex.outputs.latest }}"
          fi

          if [ "${{ steps.update-claude.outputs.updated }}" == "true" ]; then
            COMMIT_MSG="$COMMIT_MSG\n- claude-code: ${{ steps.update-claude.outputs.current }} → ${{ steps.update-claude.outputs.latest }}"
          fi

          if [ "${{ steps.update-gemini.outputs.updated }}" == "true" ]; then
            COMMIT_MSG="$COMMIT_MSG\n- gemini-cli: ${{ steps.update-gemini.outputs.current }} → ${{ steps.update-gemini.outputs.latest }}"
          fi

          git commit -m "$(echo -e "$COMMIT_MSG")"
          git push
