name: Auto-update packages

on:
  schedule:
    - cron: '0 * * * *'  # Run hourly
  workflow_dispatch:  # Allow manual trigger

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Install Nushell
        run: |
          nix profile install nixpkgs#nushell

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update codex-cli
        id: update-codex
        run: |
          OUTPUT=$(nu scripts/update-package.nu codex-cli)
          echo "$OUTPUT"

          # Parse output
          UPDATED=$(echo "$OUTPUT" | grep "updated=" | cut -d= -f2)
          CURRENT=$(echo "$OUTPUT" | grep "current=" | cut -d= -f2 || echo "")
          LATEST=$(echo "$OUTPUT" | grep "latest=" | cut -d= -f2 || echo "")

          echo "updated=$UPDATED" >> $GITHUB_OUTPUT
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "latest=$LATEST" >> $GITHUB_OUTPUT

      - name: Update claude-code
        id: update-claude
        run: |
          OUTPUT=$(nu scripts/update-package.nu claude-code)
          echo "$OUTPUT"

          # Parse output
          UPDATED=$(echo "$OUTPUT" | grep "updated=" | cut -d= -f2)
          CURRENT=$(echo "$OUTPUT" | grep "current=" | cut -d= -f2 || echo "")
          LATEST=$(echo "$OUTPUT" | grep "latest=" | cut -d= -f2 || echo "")

          echo "updated=$UPDATED" >> $GITHUB_OUTPUT
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "latest=$LATEST" >> $GITHUB_OUTPUT

      - name: Update gemini-cli
        id: update-gemini
        run: |
          OUTPUT=$(nu scripts/update-package.nu gemini-cli)
          echo "$OUTPUT"

          # Parse output
          UPDATED=$(echo "$OUTPUT" | grep "updated=" | cut -d= -f2)
          CURRENT=$(echo "$OUTPUT" | grep "current=" | cut -d= -f2 || echo "")
          LATEST=$(echo "$OUTPUT" | grep "latest=" | cut -d= -f2 || echo "")

          echo "updated=$UPDATED" >> $GITHUB_OUTPUT
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "latest=$LATEST" >> $GITHUB_OUTPUT

      - name: Update crush
        id: update-crush
        run: |
          OUTPUT=$(nu scripts/update-package.nu crush)
          echo "$OUTPUT"

          # Parse output
          UPDATED=$(echo "$OUTPUT" | grep "updated=" | cut -d= -f2)
          CURRENT=$(echo "$OUTPUT" | grep "current=" | cut -d= -f2 || echo "")
          LATEST=$(echo "$OUTPUT" | grep "latest=" | cut -d= -f2 || echo "")

          echo "updated=$UPDATED" >> $GITHUB_OUTPUT
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "latest=$LATEST" >> $GITHUB_OUTPUT

      - name: Update opencode
        id: update-opencode
        run: |
          OUTPUT=$(nu scripts/update-package.nu opencode)
          echo "$OUTPUT"

          # Parse output
          UPDATED=$(echo "$OUTPUT" | grep "updated=" | cut -d= -f2)
          CURRENT=$(echo "$OUTPUT" | grep "current=" | cut -d= -f2 || echo "")
          LATEST=$(echo "$OUTPUT" | grep "latest=" | cut -d= -f2 || echo "")

          echo "updated=$UPDATED" >> $GITHUB_OUTPUT
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "latest=$LATEST" >> $GITHUB_OUTPUT

      - name: Update pi
        id: update-pi
        run: |
          OUTPUT=$(nu scripts/update-package.nu pi)
          echo "$OUTPUT"

          # Parse output
          UPDATED=$(echo "$OUTPUT" | grep "updated=" | cut -d= -f2)
          CURRENT=$(echo "$OUTPUT" | grep "current=" | cut -d= -f2 || echo "")
          LATEST=$(echo "$OUTPUT" | grep "latest=" | cut -d= -f2 || echo "")

          echo "updated=$UPDATED" >> $GITHUB_OUTPUT
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "latest=$LATEST" >> $GITHUB_OUTPUT

      - name: Test builds
        if: steps.update-codex.outputs.updated == 'true' || steps.update-claude.outputs.updated == 'true' || steps.update-gemini.outputs.updated == 'true' || steps.update-crush.outputs.updated == 'true' || steps.update-opencode.outputs.updated == 'true' || steps.update-pi.outputs.updated == 'true'
        run: |
          echo "Testing package builds..."
          nix flake check --print-build-logs

      - name: Commit and push changes
        if: steps.update-codex.outputs.updated == 'true' || steps.update-claude.outputs.updated == 'true' || steps.update-gemini.outputs.updated == 'true' || steps.update-crush.outputs.updated == 'true' || steps.update-opencode.outputs.updated == 'true' || steps.update-pi.outputs.updated == 'true'
        run: |
          git add packages/ README.md

          COMMIT_MSG="chore: update packages"

          if [ "${{ steps.update-codex.outputs.updated }}" == "true" ]; then
            COMMIT_MSG="$COMMIT_MSG\n\n- codex-cli: ${{ steps.update-codex.outputs.current }} → ${{ steps.update-codex.outputs.latest }}"
          fi

          if [ "${{ steps.update-claude.outputs.updated }}" == "true" ]; then
            COMMIT_MSG="$COMMIT_MSG\n- claude-code: ${{ steps.update-claude.outputs.current }} → ${{ steps.update-claude.outputs.latest }}"
          fi

          if [ "${{ steps.update-gemini.outputs.updated }}" == "true" ]; then
            COMMIT_MSG="$COMMIT_MSG\n- gemini-cli: ${{ steps.update-gemini.outputs.current }} → ${{ steps.update-gemini.outputs.latest }}"
          fi

          if [ "${{ steps.update-crush.outputs.updated }}" == "true" ]; then
            COMMIT_MSG="$COMMIT_MSG\n- crush: ${{ steps.update-crush.outputs.current }} → ${{ steps.update-crush.outputs.latest }}"
          fi

          if [ "${{ steps.update-opencode.outputs.updated }}" == "true" ]; then
            COMMIT_MSG="$COMMIT_MSG\n- opencode: ${{ steps.update-opencode.outputs.current }} → ${{ steps.update-opencode.outputs.latest }}"
          fi

          if [ "${{ steps.update-pi.outputs.updated }}" == "true" ]; then
            COMMIT_MSG="$COMMIT_MSG\n- pi: ${{ steps.update-pi.outputs.current }} → ${{ steps.update-pi.outputs.latest }}"
          fi

          git commit -m "$(echo -e "$COMMIT_MSG")"
          git push
